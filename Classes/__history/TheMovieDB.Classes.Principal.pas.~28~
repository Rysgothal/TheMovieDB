unit TheMovieDB.Classes.Principal;

interface

uses
  System.SysUtils, REST.Client;

type
  TTheMovieDBApi = class
  private
    FClient: TRESTClient;
    FRequest: TRESTRequest;
    FChaveValida: Boolean;
    FIDSessao: string;
    constructor Create;
    class var FTheMovieDBApi: TTheMovieDBApi;

    const THE_MOVIE_DB_API_URL = 'https://api.themoviedb.org/3';
    const THE_MOVIE_DB_API_KEY = 'b3617d826e0f0c422bf57fdb53a0b418';
    const THE_MOVIE_DB_API_ACESS_TOKEN = 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJiMzYxN2Q4MjZlMGYwYzQyMmJmNTdmZGI1M' +
      '2EwYjQxOCIsIm5iZiI6MTcyMjk0NDUxMC4xNDI3MzUsInN1YiI6IjY2NGU4NmEwNDA3YmFlZGY4MGJiMGI5YyIsInNjb3BlcyI6WyJhcGlfc' +
      'mVhZCJdLCJ2ZXJzaW9uIjoxfQ.hxe0z1VkWHVSCo0IBCnWD-IxqpPl0_ug1PYlP2Ccz04';
    procedure Consultar;
  public
    destructor Destroy; override;
    property ChaveValida: Boolean read FChaveValida;
    property IDSessao: string read FIDSessao write FIDSessao;
    class function ObterInstancia: TTheMovieDBApi;
    function CriarSessaoConvidado: string;
  end;

implementation

uses
  REST.Types, Vcl.Dialogs, TheMovieDB.Helpers.Principal,
  TheMovieDB.Classes.JSONSessaoConvidado, REST.JSON, System.JSON;

{ TTheMovieDBApi }

procedure TTheMovieDBApi.Consultar;
begin
  FClient.Accept := 'application/json';
  FClient.AddParameter('Authorization', THE_MOVIE_DB_API_ACESS_TOKEN, TRESTRequestParameterKind.pkHTTPHEADER,
    [poDoNotEncode]);

  FRequest.Client := FClient;
  FRequest.Execute;
end;

constructor TTheMovieDBApi.Create;
begin
  FClient := TRESTClient.Create(THE_MOVIE_DB_API_URL + '/authentication');
  FRequest := TRESTRequest.Create(FClient);

  Consultar;
  FChaveValida := THelpersTheMovieDB.StatusOK(FRequest.Response.StatusCode);

  if not FChaveValida then
  begin
    raise Exception.Create('Chave inválida');
  end;
end;

function TTheMovieDBApi.CriarSessaoConvidado: string;
var
  lSessaoConvidado: TTMDBSessaoConvidado;
  lJSON: TJSONValue;
begin
  FClient.BaseURL := THE_MOVIE_DB_API_URL + '/authentication/guest_session/new';
  Consultar;

  lJSON := FRequest.Response.JSONValue;
  lSessaoConvidado := TJson.JsonToObject<TTMDBSessaoConvidado>(TJSONObject(lJSON));

  Result := lSessaoConvidado.SessaoID;
end;

destructor TTheMovieDBApi.Destroy;
begin
  FreeAndNil(FRequest);
  FreeAndNil(FClient);
  inherited;
end;

class function TTheMovieDBApi.ObterInstancia: TTheMovieDBApi;
begin
  if Self.FTheMovieDBApi = nil then
  begin
    Self.FTheMovieDBApi := TTheMovieDBApi.Create;
  end;

  Result := Self.FTheMovieDBApi;
end;

initialization

finalization
  FreeAndNil(TTheMovieDBApi.FTheMovieDBApi);

end.
